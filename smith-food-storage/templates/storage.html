<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Smith Food Storage | My Storage</title>

  <!-- Google Fonts -->
  <link
    href="https://fonts.googleapis.com/css2?family=Rock+Salt&family=Roboto&display=swap"
    rel="stylesheet"
  >

  <!-- your own styles -->
  <link
    rel="stylesheet"
    href="{{ url_for('static', filename='styles/style.css') }}"
  >

  <!-- jQuery (for inline editing AJAX) -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"
          integrity="sha256-/xUj+3OJ+Y3GkrKjb+6ymAti8od0OqpmLp+YQ5nZ+KA="
          crossorigin="anonymous"></script>

  <style>
    /* Quick inline tweaks */
    #storage-table { width: 100%; border-collapse: collapse; margin-top: 1em; }
    #storage-table th, #storage-table td {
      border: 1px solid #ddd; padding: 0.5em; text-align: left;
    }
    #storage-table th { background: #fff; cursor: pointer; }
    .btn-delete {
      background: transparent; border: none; color: red;
      font-size: 1.2em; cursor: pointer;
    }
    .sort-select { margin-bottom: 1em; }
    .editable, .editable-date {
      display: inline-block; min-width: 2ch;
      padding: 2px 4px; border-radius: 3px;
    }
    .editable:hover, .editable-date:hover {
      background: rgba(255,255,255,0.2);
    }
  </style>
</head>
<body>
  <div id="content">

    <!-- Header -->
    <header>
      <div class="nav-icons">
        <a href="{{ url_for('home') }}">
          <img class="logo"
               src="{{ url_for('static', filename='images/updated_smith_food_storage_logo.jpg') }}"
               alt="Home">
        </a>
        <a href="{{ url_for('add_food') }}">
          <img class="logo"
               src="{{ url_for('static', filename='images/addfoodlogo.jpg') }}"
               alt="Add Food">
        </a>
        <a href="{{ url_for('storage') }}">
          <img class="logo"
               src="{{ url_for('static', filename='images/mystoragelogo.jpg') }}"
               alt="My Storage">
        </a>
      </div>
    </header>

    <!-- Intro & Sort Control -->
    <section id="scenery-overlay">
      <h2>My Storage</h2>
      <p>
        Below is everything you’ve added. Use “×” to delete, click a cell to edit inline,
        or pick a sort order:
      </p>
      <select class="sort-select" id="sort-by">
        <option value="">-- Sort by --</option>
        <option value="0">Name</option>
        <option value="1">Qty</option>
        <option value="2">Expires</option>
        <option value="4">Store</option>
        <option value="5">Category</option>
        <option value="6">Location</option>
      </select>
    </section>

    <!-- Storage Table -->
    <main>
      {% if items %}
      <table id="storage-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Qty</th>
            <th>Expires</th>
            <th>Price</th>
            <th>Store</th>
            <th>Category</th>
            <th>Location</th>
            <th>Del</th>
          </tr>
        </thead>
        <tbody>
          {% for i in items %}
          <tr>
            <!-- inline editable name -->
            <td>
              <span class="editable"
                    data-id="{{ i.item_id }}"
                    data-field="name">{{ i.name }}</span>
            </td>

            <!-- inline editable quantity -->
            <td>
              <span class="editable"
                    data-id="{{ i.item_id }}"
                    data-field="quantity">{{ i.quantity }}</span>
            </td>

            <!-- inline editable expires -->
            <td>
              <span class="editable-date"
                    data-id="{{ i.item_id }}"
                    data-field="expires">{{ i.expires or '' }}</span>
            </td>

            <!-- price (non‑editable for now) -->
            <td>
              {% if i.purchase_price %}${{ '%.2f'|format(i.purchase_price) }}
              {% else %}—{% endif %}
            </td>

            <!-- store, category, location (static) -->
            <td>{{ i.store.name if i.store else '—' }}</td>
            <td>{{ i.category.name if i.category else '—' }}</td>
            <td>{{ i.location.name if i.location else '—' }}</td>

            <!-- delete button -->
            <td>
              <form action="{{ url_for('delete_item', item_id=i.item_id) }}"
                    method="post">
                <button type="submit" class="btn-delete" title="Delete">
                  &times;
                </button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
        <p>No items in storage yet. <a href="{{ url_for('add_food') }}">Add some.</a></p>
      {% endif %}
    </main>

    <!-- Footer -->
    <footer>
      <div class="footer-left">
        Smith Food Storage &copy; 2025 – Trevor Smith
      </div>
      <div class="footer-links">
        <a href="{{ url_for('site_plan') }}">Site Plan</a>
        <a href="{{ url_for('contact_us') }}">Contact Us</a>
        <a href="{{ url_for('run_program') }}">Analysis</a>
      </div>
      <div class="social">
        <a href="https://facebook.com" target="_blank">
          <img
            src="{{ url_for('static', filename='images/facebook.png') }}"
            alt="Facebook">
        </a>
        <a href="https://twitter.com" target="_blank">
          <img
            src="{{ url_for('static', filename='images/twitter.png') }}"
            alt="Twitter">
        </a>
        <a href="https://instagram.com" target="_blank">
          <img
            src="{{ url_for('static', filename='images/instagram.png') }}"
            alt="Instagram">
        </a>
      </div>
    </footer>
  </div>

  <script>
    // -- Inline‐edit handler for text/number fields --
    $('#storage-table').on('click', '.editable', function(){
      const $span = $(this);
      const fld   = $span.data('field');
      const id    = $span.data('id');
      const old   = $span.text().trim();

      // create an input
      const $inp = $('<input>')
        .val(old)
        .css({ width: fld==='name'? '6em':'3em' })
        .on('blur keydown', function(e){
          if (e.type==='blur' || e.key==='Enter') {
            let val = $(this).val().trim();
            if (fld==='quantity') val = parseInt(val) || 0;
            // send update
            $.post(`/edit-item/${id}`, { field: fld, value: val })
              .fail(()=> alert('Update failed'));
            // restore span
            $span.text(val).show();
            $inp.remove();
          }
        });
      $span.hide().after($inp);
      $inp.focus();
    });

    // -- Inline‐edit handler for date fields --
    $('#storage-table').on('click', '.editable-date', function(){
      const $span = $(this);
      const id    = $span.data('id');
      const old   = $span.text().trim();
      const $inp  = $('<input type="date">')
        .val(old)
        .css({ width: '8em' })
        .on('blur change', function(){
          const val = $(this).val();
          $.post(`/edit-item/${id}`, { field: 'expires', value: val })
            .fail(()=> alert('Date update failed'));
          $span.text(val).show();
          $inp.remove();
        });
      $span.hide().after($inp);
      $inp.focus();
    });

    // -- Simple client‐side sort by column index --
    $('#sort-by').on('change', function(){
      const col = +this.value;
      if (isNaN(col)) return;
      const $rows = $('#storage-table tbody tr').get();
      $rows.sort((a,b)=>{
        const A = $(a).children('td').eq(col).text().trim(),
              B = $(b).children('td').eq(col).text().trim();
        return isNaN(A)? A.localeCompare(B) : ( +A - +B );
      });
      $.each($rows, (_,r)=> $('#storage-table tbody').append(r) );
    });
  </script>
</body>
</html>
