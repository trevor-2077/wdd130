<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google Fonts + your CSS -->
  <link
    href="https://fonts.googleapis.com/css2?family=Rock+Salt&family=Roboto&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles/style.css') }}">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Smith Food Storage | My Storage</title>
  <style>
    table { width:100%; border-collapse: collapse; margin-top:1em; }
    th, td { border:1px solid #ddd; padding:0.5em; }
    th { background:#f4f4f4; }
    .btn-delete { background:transparent; border:none; color:red; font-size:1.2em; cursor:pointer; }
    .sort-select { margin-top:0.5em; }
    input[type="text"], input[type="number"], input[type="date"], select {
      width:100%; box-sizing:border-box;
    }
  </style>
</head>
<body>
  <div id="content">
    <header>
      <div class="nav-icons">
        <a href="{{ url_for('home') }}">
          <img class="logo"
               src="{{ url_for('static', filename='images/updated_smith_food_storage_logo.jpg') }}"
               alt="Home">
        </a>
        <a href="{{ url_for('add_food') }}">
          <img class="logo"
               src="{{ url_for('static', filename='images/addfoodlogo.jpg') }}"
               alt="Add Food">
        </a>
        <a href="{{ url_for('storage') }}">
          <img class="logo"
               src="{{ url_for('static', filename='images/mystoragelogo.jpg') }}"
               alt="My Storage">
        </a>
      </div>
    </header>

    <section id="scenery-overlay">
      <h2>My Storage</h2>
      <p>Below is everything you’ve added. Use “×” to delete, click a cell to edit inline, or pick a sort order:</p>
      <select id="sortBy" class="sort-select">
        <option value="expires">Expires</option>
        <option value="quantity">Qty</option>
        <option value="name">Name</option>
        <option value="store">Store</option>
        <option value="category">Category</option>
        <option value="location">Location</option>
      </select>
    </section>

    <main>
      {% if items %}
      <table id="storageTable">
        <thead>
          <tr>
            <th>Name</th>
            <th>Qty</th>
            <th>Expires</th>
            <th>Price</th>
            <th>Store</th>
            <th>Category</th>
            <th>Location</th>
            <th>Del</th>
          </tr>
        </thead>
        <tbody>
          {% for i in items %}
          <tr data-item-id="{{ i.item_id }}">
            <td><input type="text" class="inline-edit" data-field="name" value="{{ i.name }}"></td>
            <td><input type="number" class="inline-edit" data-field="quantity" value="{{ i.quantity }}"></td>
            <td><input type="date" class="inline-edit" data-field="expires" value="{{ i.expires or '' }}"></td>
            <td>
              {% if i.purchase_price %}${{ '%.2f'|format(i.purchase_price) }}{% else %}—{% endif %}
            </td>
            <td>
              <select class="inline-edit" data-field="store_id">
                <option value="">—</option>
                {% for id,name in stores.items() %}
                <option value="{{ id }}" {% if id==i.store_id %}selected{% endif %}>{{ name }}</option>
                {% endfor %}
              </select>
            </td>
            <td>
              <select class="inline-edit" data-field="category_id">
                <option value="">—</option>
                {% for id,name in categories.items() %}
                <option value="{{ id }}" {% if id==i.category_id %}selected{% endif %}>{{ name }}</option>
                {% endfor %}
              </select>
            </td>
            <td>
              <select class="inline-edit" data-field="location_id">
                <option value="">—</option>
                {% for id,name in locations.items() %}
                <option value="{{ id }}" {% if id==i.location_id %}selected{% endif %}>{{ name }}</option>
                {% endfor %}
              </select>
            </td>
            <td>
              <form action="{{ url_for('delete_item', item_id=i.item_id) }}" method="post" style="display:inline">
                <button type="submit" class="btn-delete">&times;</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
        <p>No items yet. <a href="{{ url_for('add_food') }}">Add some.</a></p>
      {% endif %}
    </main>
  </div>

  <script>
    function postForm(u,d,cb){
      fetch(u,{
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body:new URLSearchParams(d)
      }).then(r=>r.json()).then(cb).catch(e=>alert('Error:'+e));
    }
    document.querySelectorAll('.inline-edit').forEach(el=>{
      el.addEventListener('change',e=>{
        let fld=e.target.dataset.field,
            val=e.target.value,
            row=e.target.closest('tr'),
            id = row.dataset.itemId;
        postForm(`/edit-item/${id}`,{field:fld,value:val},resp=>{
          if(!resp.success) alert(resp.error);
        });
      });
    });
    document.getElementById('sortBy').addEventListener('change',e=>{
      const map={name:0,quantity:1,expires:2,price:3,store:4,category:5,location:6},
            col=map[e.target.value],
            tbody=document.querySelector('#storageTable tbody'),
            rows=Array.from(tbody.rows);
      rows.sort((a,b)=>{
        let A=a.cells[col].innerText.trim(),
            B=b.cells[col].innerText.trim();
        if(col===1){A=+A;B=+B;}
        if(col===2){A=new Date(A);B=new Date(B);}
        return A>B?1:(A<B?-1:0);
      }).forEach(r=>tbody.appendChild(r));
    });
  </script>
</body>
</html>
